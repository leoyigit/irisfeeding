<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Leo Yigit Ekiz">
    <meta name="copyright" content="Copyright 2025, Leo Yigit Ekiz">
    <title>Iris Feeding & Weight Tracker</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 1024'%3E%3Cpath d='M954.026667 719.36h-86.186667c-29.013333 0-52.906667-23.893333-52.906667-52.906667V570.026667c0-29.013333 23.893333-52.906667 52.906667-52.906667h86.186667c29.013333 0 52.906667 23.893333 52.906666 52.906667V665.6c0 29.866667-23.893333 53.76-52.906666 53.76z' fill='%23FCE4EC'/%3E%3Cpath d='M954.026667 736.426667h-86.186667c-38.4 0-69.973333-31.573333-69.973333-69.973334V570.026667c0-38.4 31.573333-69.973333 69.973333-69.973334h86.186667c38.4 0 69.973333 31.573333 69.973333 69.973334V665.6c0 39.253333-31.573333 70.826667-69.973333 70.826667z m-86.186667-202.24c-19.626667 0-35.84 16.213333-35.84 35.84V665.6c0 19.626667 16.213333 35.84 35.84 35.84h86.186667c19.626667 0 35.84-16.213333 35.84-35.84V570.026667c0-19.626667-16.213333-35.84-35.84-35.84h-86.186667z' fill='%23EC407A'/%3E%3Cpath d='M156.16 719.36H69.973333c-29.013333 0-52.906667-23.893333-52.906666-52.906667V570.026667c0-29.013333 23.893333-52.906667 52.906666-52.906667h86.186667c29.013333 0 52.906667 23.893333 52.906667 52.906667V665.6c0 29.866667-23.893333 53.76-52.906667 53.76z' fill='%23FCE4EC'/%3E%3Cpath d='M156.16 736.426667H69.973333c-38.4 0-69.973333-31.573333-69.973333-69.973334V570.026667c0-38.4 31.573333-69.973333 69.973333-69.973334h86.186667c38.4 0 69.973333 31.573333 69.973333 69.973334V665.6c0 39.253333-31.573333 70.826667-69.973333 70.826667zM69.973333 534.186667c-19.626667 0-35.84 16.213333-35.84 35.84V665.6c0 19.626667 16.213333 35.84 35.84 35.84h86.186667c19.626667 0 35.84-16.213333 35.84-35.84V570.026667c0-19.626667-16.213333-35.84-35.84-35.84H69.973333z' fill='%23EC407A'/%3E%3Cpath d='M112.64 581.12v-145.066667l34.133333 17.92c220.16 115.2 482.986667 119.466667 706.56 9.386667l57.173334-28.16v145.066667c0 175.786667-142.506667 317.44-317.44 317.44h-162.133334c-175.786667 0.853333-318.293333-141.653333-318.293333-316.586667z' fill='%23FCE4EC'/%3E%3Cpath d='M593.066667 915.626667h-162.133334c-184.32 0-334.506667-150.186667-334.506666-334.506667v-145.066667c0-5.973333 3.413333-11.093333 8.533333-14.506666s11.093333-3.413333 17.066667-0.853334l34.133333 17.92c215.04 112.64 473.6 116.053333 691.2 9.386667l57.173333-28.16c5.12-2.56 11.946667-2.56 16.213334 0.853333 5.12 3.413333 7.68 8.533333 7.68 14.506667v145.066667c0 185.173333-150.186667 335.36-335.36 335.36zM129.706667 464.213333V580.266667c0 165.546667 134.826667 300.373333 300.373333 300.373333h162.986667c165.546667 0 300.373333-134.826667 300.373333-300.373333V463.36l-32.426667 16.213333C634.026667 591.36 364.373333 587.093333 139.946667 469.333333l-10.24-5.12z' fill='%23EC407A'/%3E%3Cpath d='M113.493333 394.24a398.506667 136.533333 0 1 0 797.013334 0 398.506667 136.533333 0 1 0-797.013334 0Z' fill='%23F48FB1'/%3E%3Cpath d='M512 547.84c-108.373333 0-209.92-14.506667-287.573333-40.96-83.626667-29.013333-128-67.413333-128-112.64s44.373333-83.626667 128-112.64c76.8-26.453333 179.2-40.96 287.573333-40.96s209.92 14.506667 287.573333 40.96c83.626667 29.013333 128 67.413333 128 112.64s-44.373333 83.626667-128 112.64c-77.653333 26.453333-179.2 40.96-287.573333 40.96z m0-273.066667c-224.426667 0-381.44 63.146667-381.44 119.466667s156.16 119.466667 381.44 119.466667c224.426667 0 381.44-63.146667 381.44-119.466667s-157.013333-119.466667-381.44-119.466667z' fill='%23EC407A'/%3E%3Cpath d='M938.666667 240.64L520.533333 478.72c-5.12 38.4 3.413333 132.266667-133.12 98.133333l-102.4-34.133333c68.266667-128 136.533333-93.866667 189.44-108.373333l392.533334-297.813334c29.013333-19.626667 68.266667-11.946667 87.893333 16.213334 20.48 29.013333 12.8 68.266667-16.213333 87.893333z' fill='%23FFFFFF'/%3E%3Cpath d='M439.466667 601.6c-16.213333 0-34.986667-2.56-56.32-7.68h-0.853334l-102.4-34.133333c-5.12-1.706667-8.533333-5.12-10.24-10.24-1.706667-4.266667-1.706667-10.24 0.853334-14.506667 57.173333-106.666667 116.053333-110.08 163.84-112.64 11.946667-0.853333 23.04-1.706667 33.28-3.413333l389.973333-295.253334c17.92-12.8 40.106667-17.066667 60.586667-12.8 21.333333 4.266667 39.253333 16.213333 51.2 33.28 11.946667 17.92 16.213333 39.253333 12.8 59.733334-4.266667 21.333333-16.213333 39.253333-33.28 51.2l-0.853334 0.853333-411.306666 232.96v4.266667c-2.56 27.306667-5.973333 68.266667-38.4 91.306666-15.36 11.093333-34.986667 17.066667-58.88 17.066667zM392.533333 560.64c40.106667 10.24 69.12 8.533333 86.186667-3.413333 19.626667-14.506667 22.186667-42.666667 23.893333-66.56 0.853333-5.12 0.853333-10.24 1.706667-14.506667 0.853333-5.12 3.413333-10.24 8.533333-12.8L930.133333 226.133333c10.24-6.826667 16.213333-17.066667 18.773334-29.013333 2.56-11.946667 0-24.746667-7.68-34.133333-6.826667-10.24-17.066667-17.066667-29.866667-19.626667-11.946667-2.56-24.746667 0-34.133333 7.68l-392.533334 296.96c-1.706667 1.706667-3.413333 2.56-5.973333 2.56-14.506667 4.266667-29.013333 5.12-43.52 5.973333-40.106667 2.56-81.92 5.12-125.44 76.8l82.773333 27.306667z m546.133334-320z' fill='%23EC407A'/%3E%3Cpath d='M854.186667 464.213333c-223.573333 109.226667-486.4 105.813333-706.56-9.386666l-34.133334-17.92v85.333333l34.133334 17.92c220.16 115.2 482.986667 119.466667 706.56 9.386667l57.173333-28.16v-85.333334l-57.173333 28.16z' fill='%23FFEE58'/%3E%3Cpath d='M510.293333 645.973333c-128 0-255.146667-30.72-371.2-91.306666l-34.133333-17.92c-5.973333-2.56-9.386667-8.533333-9.386667-15.36v-85.333334c0-5.973333 3.413333-11.093333 8.533334-14.506666s11.093333-3.413333 17.066666-0.853334l34.133334 17.92c215.04 112.64 473.6 116.053333 691.2 9.386667l57.173333-28.16c5.12-2.56 11.946667-2.56 16.213333 0.853333 5.12 3.413333 7.68 8.533333 7.68 14.506667v85.333333c0 6.826667-3.413333 12.8-9.386666 15.36l-57.173334 28.16c-110.08 54.613333-230.4 81.92-350.72 81.92zM129.706667 511.146667l25.6 13.653333c215.04 112.64 473.6 116.053333 691.2 9.386667l46.933333-23.04v-46.933334l-32.426667 16.213334c-226.986667 110.933333-496.64 106.666667-721.066666-11.093334l-9.386667-5.12v46.933334z m724.48-46.933334z' fill='%23EC407A'/%3E%3Cpath d='M593.066667 915.626667h-162.133334c-184.32 0-334.506667-150.186667-334.506666-334.506667v-145.066667c0-5.973333 3.413333-11.093333 8.533333-14.506666s11.093333-3.413333 17.066667-0.853334l34.133333 17.92c215.04 112.64 473.6 116.053333 691.2 9.386667l57.173333-28.16c5.12-2.56 11.946667-2.56 16.213334 0.853333 5.12 3.413333 7.68 8.533333 7.68 14.506667v145.066667c0 185.173333-150.186667 335.36-335.36 335.36zM129.706667 464.213333V580.266667c0 165.546667 134.826667 300.373333 300.373333 300.373333h162.986667c165.546667 0 300.373333-134.826667 300.373333-300.373333V463.36l-32.426667 16.213333C634.026667 591.36 364.373333 587.093333 139.946667 469.333333l-10.24-5.12z' fill='%23EC407A'/%3E%3Cpath d='M843.093333 461.653333v119.466667c0 175.786667-142.506667 317.44-317.44 317.44h51.2c175.786667 0 317.44-142.506667 317.44-317.44v-145.066667l-51.2 25.6z' fill='%23F8BBD0'/%3E%3Cpath d='M843.093333 461.653333v81.92l51.2-21.333333V436.053333z' fill='%23FBC02D'/%3E%3Cpath d='M484.693333 543.573333c-116.053333-3.413333-231.253333-33.28-337.066666-88.746666l-34.133334-17.92v26.453333c116.053333 57.173333 244.053333 84.48 371.2 80.213333z' fill='%23F06292'/%3E%3Cpath d='M669.013333 700.586667m-19.626666 0a19.626667 19.626667 0 1 0 39.253333 0 19.626667 19.626667 0 1 0-39.253333 0Z' fill='%23F48FB1'/%3E%3Cpath d='M669.013333 737.28c-20.48 0-36.693333-16.213333-36.693333-36.693333s16.213333-36.693333 36.693333-36.693334 36.693333 16.213333 36.693334 36.693334-16.213333 36.693333-36.693334 36.693333z m0-39.253333c-1.706667 0-2.56 0.853333-2.56 2.56s0.853333 2.56 2.56 2.56 2.56-0.853333 2.56-2.56s-0.853333-2.56-2.56-2.56z' fill='%23EC407A'/%3E%3Cpath d='M354.986667 700.586667m-19.626667 0a19.626667 19.626667 0 1 0 39.253333 0 19.626667 19.626667 0 1 0-39.253333 0Z' fill='%23F48FB1'/%3E%3Cpath d='M354.986667 737.28c-20.48 0-36.693333-16.213333-36.693334-36.693333s16.213333-36.693333 36.693334-36.693334 36.693333 16.213333 36.693333 36.693334-16.213333 36.693333-36.693333 36.693333z m0-39.253333c-1.706667 0-2.56 0.853333-2.56 2.56s0.853333 2.56 2.56 2.56c1.706667 0 2.56-0.853333 2.56-2.56s-0.853333-2.56-2.56-2.56z' fill='%23EC407A'/%3E%3Cpath d='M512 855.04c-50.346667 0-101.546667-13.653333-145.92-41.813333-7.68-5.12-10.24-15.36-5.12-23.893334 5.12-7.68 15.36-10.24 23.893333-5.12 77.653333 48.64 177.493333 48.64 255.146667 0 7.68-5.12 18.773333-2.56 23.893333 5.12 5.12 7.68 2.56 18.773333-5.12 23.893334-45.226667 27.306667-96.426667 41.813333-146.773333 41.813333z' fill='%23EC407A'/%3E%3Cpath d='M593.066667 915.626667h-162.133334c-184.32 0-334.506667-150.186667-334.506666-334.506667v-145.066667c0-5.973333 3.413333-11.093333 8.533333-14.506666s11.093333-3.413333 17.066667-0.853334l34.133333 17.92c215.04 112.64 473.6 116.053333 691.2 9.386667l57.173333-28.16c5.12-2.56 11.946667-2.56 16.213334 0.853333 5.12 3.413333 7.68 8.533333 7.68 14.506667v145.066667c0 185.173333-150.186667 335.36-335.36 335.36zM129.706667 464.213333V580.266667c0 165.546667 134.826667 300.373333 300.373333 300.373333h162.986667c165.546667 0 300.373333-134.826667 300.373333-300.373333V463.36l-32.426667 16.213333C634.026667 591.36 364.373333 587.093333 139.946667 469.333333l-10.24-5.12z' fill='%23EC407A'/%3E%3Cpath d='M510.293333 645.973333c-128 0-255.146667-30.72-371.2-91.306666l-34.133333-17.92c-5.973333-2.56-9.386667-8.533333-9.386667-15.36v-85.333334c0-5.973333 3.413333-11.093333 8.533334-14.506666s11.093333-3.413333 17.066666-0.853334l34.133334 17.92c215.04 112.64 473.6 116.053333 691.2 9.386667l57.173333-28.16c5.12-2.56 11.946667-2.56 16.213333 0.853333 5.12 3.413333 7.68 8.533333 7.68 14.506667v85.333333c0 6.826667-3.413333 12.8-9.386666 15.36l-57.173334 28.16c-110.08 54.613333-230.4 81.92-350.72 81.92zM129.706667 511.146667l25.6 13.653333c215.04 112.64 473.6 116.053333 691.2 9.386667l46.933333-23.04v-46.933334l-32.426667 16.213334c-226.986667 110.933333-496.64 106.666667-721.066666-11.093334l-9.386667-5.12v46.933334z m724.48-46.933334z' fill='%23EC407A'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="https://storage.googleapis.com/gemini-generative-ai-public/iris-app/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pink: {
                            500: '#ec4899',
                            600: '#db2777',
                        },
                    },
                },
            },
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/customParseFormat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/isSameOrBefore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #ec4899; cursor: pointer; border-radius: 50%; }
        #history-modal, #loading-overlay, #edit-modal, #insight-detail-modal, #weight-modal { display: none; }
        #age-in-days, #insight-section, #latest-weight-card { cursor: pointer; user-select: none; }
        .arrow-icon svg { transition: transform 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <audio id="myCorrectaudio" loop>
        <source src="om.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"><div class="text-white text-lg">Saving...</div></div>

    <div id="app-container" class="max-w-md mx-auto p-4 min-h-screen">
        <div class="flex justify-between items-center text-center p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg mb-6">

            <button id="audio-toggle-btn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" title="Play/Pause Sound"></button>

            <div>
                <h1 id="baby-name" class="text-3xl font-bold text-pink-500"></h1>
                <p id="age-in-days" class="text-lg text-gray-500 dark:text-gray-400 mt-1" title="Click to change format"></p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Dark/Light Mode"></button>
        </div>

        <div id="insight-section" class="bg-pink-800 dark:bg-pink-900 border border-pink-500 rounded-xl shadow-lg p-4 mb-6 transition hover:bg-pink-700" style="display: none;" title="Click to read more">
            <h3 class="text-lg font-semibold text-white dark:text-pink-100 mb-2">âœ¨ Daily Insight</h3>
            <p id="daily-insight-text" class="text-sm text-white/90 dark:text-pink-200"></p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 grid grid-cols-2 gap-4 text-center">
            <div><h2 class="text-xl font-semibold mb-1">Today's Total</h2><p id="total-today" class="text-3xl font-bold text-pink-500"></p><p id="total-summary-subtitle" class="text-sm text-gray-500 dark:text-gray-400"></p></div>
            <div id="latest-weight-card" class="transition hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg p-2 -m-2"><h2 class="text-xl font-semibold mb-1">Latest Weight</h2><p id="latest-weight" class="text-3xl font-bold text-pink-500"></p><p class="text-sm text-gray-500 dark:text-gray-400" id="latest-weight-date"></p></div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-center">Add New Feeding</h2>
            <form id="feeding-form" class="space-y-4">
                <div><label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount: <span id="amount-value" class="font-bold text-pink-500">100 ml</span></label><input type="range" id="amount" name="amount" min="10" max="200" step="10" value="100" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer mt-2"></div>
                <div><label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label><input type="text" id="notes" name="notes" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-3" placeholder="e.g., a little fussy"></div>
                <button type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg">Add Feeding</button>
            </form>
        </div>

        <div>
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Today's Logs</h2><button id="view-history-btn" class="text-sm text-pink-500 font-semibold hover:underline">View History</button></div>
            <div id="feedings-list" class="space-y-3"><p id="loading-state" class="text-center text-gray-500">Loading entries...</p></div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] m-4 flex flex-col"><div class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">Full History</h2><button id="close-history-btn" class="text-gray-500 hover:text-gray-900 dark:hover:text-white text-2xl leading-none">&times;</button></div><div id="history-content" class="p-6 overflow-y-auto"></div></div></div>
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm m-4"><form id="edit-form" novalidate><div class="p-4 border-b dark:border-gray-700"><h2 class="text-xl font-bold">Edit Feeding</h2></div><div class="p-6 space-y-4"><input type="hidden" id="edit-id"><div><label for="edit-amount" class="block text-sm font-medium">Amount (ml)</label><input type="number" id="edit-amount" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 rounded-md p-3"></div><div><label for="edit-notes" class="block text-sm font-medium">Notes</label><input type="text" id="edit-notes" class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 rounded-md p-3"></div></div><div class="px-6 py-4 bg-gray-50 dark:bg-gray-700/50 flex justify-between items-center"><button type="button" id="delete-btn" class="text-sm font-semibold text-red-500 hover:text-red-700">Delete</button><div><button type="button" id="cancel-edit-btn" class="px-4 py-2 rounded-lg mr-2">Cancel</button><button type="submit" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></div></div></form></div></div>
    <div id="insight-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg m-4 max-h-[90vh] flex flex-col"><div class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">Today's Insight</h2><button id="close-insight-btn" class="text-gray-500 hover:text-gray-900 dark:hover:text-white text-2xl leading-none">&times;</button></div><div class="p-6 overflow-y-auto"><p id="insight-detail-content" class="whitespace-pre-wrap"></p></div></div></div>
    <div id="weight-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm m-4"><div class="p-4 border-b dark:border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">Log New Weight</h2><button id="close-weight-btn" class="text-gray-500 hover:text-gray-900 dark:hover:text-white text-2xl leading-none">&times;</button></div><div class="p-6"><form id="weight-form" class="flex items-center space-x-2"><input type="number" id="weight-grams" required class="block w-full bg-gray-100 dark:bg-gray-700 rounded-md p-3" placeholder="Weight in grams"><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Save</button></form></div></div></div>

    <script type="module">
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwd5FlajGPdIP-kZEfsZep56ixMxwzurFKUYawaIU8GIu0uAFk4KvADNj19r_8oHr_m/exec';
        const BABY_BIRTHDAY = '2025-05-03T00:20:00';
        const BABY_NAME = 'Iris';

        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.extend(window.dayjs_plugin_customParseFormat);
        dayjs.extend(window.dayjs_plugin_isSameOrBefore);

        // --- GLOBAL STATE ---
        let allFeedings = [], allWeights = [], allTips = [], weightChart = null;
        const ageFormats = ['days', 'months-days', 'weeks-days', 'hours', 'minutes', 'seconds'];
        let currentAgeFormatIndex = 0;
        let ageUpdateInterval = null;

        // --- ICON DEFINITIONS ---
        const sunIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
        const moonIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
        const chevronDownIcon = `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
        const playIcon = `<svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>`;
        const pauseIcon = `<svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5zm6.5 0a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"></path></svg>`;
        
        // --- ASYNC DATA & API FUNCTIONS ---
        async function loadData() {
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`Server responded with status ${response.status}.`);
                const data = await response.json();
                allFeedings = data.feedings || [];
                allWeights = data.weights || [];
                allTips = data.tips || [];
                renderAllUI();
            } catch (error) { console.error("ERROR LOADING DATA:", error); document.getElementById('app-container').innerHTML = `<div class="p-4 bg-red-100"><p class="font-bold">Fatal Error</p><p>${error.message}</p></div>`; }
        }

        // --- CORRECTED saveData FUNCTION ---
        async function saveData(payload) {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.result !== 'success') {
                    throw new Error(`Script error: ${result.message}`);
                }
                
                // Reload data from the server now that we know the save was successful
                await loadData();

            } catch (error) {
                console.error("Error saving data:", error);
                alert(`Could not save data: ${error.message}`);
            } finally {
                // Hide the loading overlay whether the save succeeded or failed
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // --- UI RENDERING FUNCTIONS ---
        function renderAllUI() {
            renderDailyInsight();
            renderTodaysFeedings();
            renderLatestWeight();
        }
        function renderDailyInsight() {
            const insightSection = document.getElementById('insight-section'), insightTextEl = document.getElementById('daily-insight-text');
            if (!allTips || !insightSection) return;
            const tipForToday = allTips.find(tip => dayjs(tip.date).isSame(dayjs(), 'day'));
            if (tipForToday) { insightTextEl.textContent = tipForToday.short; insightSection.dataset.expandedText = tipForToday.expanded || tipForToday.short; insightSection.style.display = 'block'; } else { insightSection.style.display = 'none'; }
        }
        function renderTodaysFeedings() {
            const list = document.getElementById('feedings-list'), totalEl = document.getElementById('total-today'), subtitleEl = document.getElementById('total-summary-subtitle');
            const todaysFeedings = allFeedings.filter(f => dayjs(f.timestamp).isSame(dayjs(), 'day')).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const totalAmount = todaysFeedings.reduce((sum, f) => sum + f.amount, 0);
            list.innerHTML = todaysFeedings.length ? todaysFeedings.map(createFeedingHTML).join('') : `<p class="text-center text-gray-500 dark:text-gray-400">No feedings logged for today.</p>`;
            totalEl.textContent = `${totalAmount} ml`;
            subtitleEl.textContent = `${todaysFeedings.length} feedings`;
        }
        function renderLatestWeight() {
            const weightEl = document.getElementById('latest-weight'), dateEl = document.getElementById('latest-weight-date');
            if (allWeights.length > 0) {
                const latest = [...allWeights].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                weightEl.textContent = `${latest.grams} g`;
                dateEl.textContent = dayjs(latest.timestamp).format('MMM D, HH:mm');
            } else { weightEl.textContent = `- g`; dateEl.textContent = "No data"; }
        }
        const createFeedingHTML = (f) => `<div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex justify-between items-start animate-fade-in"><div><p class="font-semibold">${f.amount} ml</p>${f.notes ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${f.notes}</p>` : ''}</div><div class="flex items-center space-x-2 ml-2"><p class="text-sm text-gray-500 dark:text-gray-400">${dayjs(f.timestamp).format('HH:mm')}</p><button class="edit-btn p-1 text-gray-400 hover:text-blue-500" data-id="${f.timestamp}" data-amount="${f.amount}" data-notes="${f.notes || ''}"><svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"/></svg></button></div></div>`;
        function showHistory() {
            const historyContent = document.getElementById('history-content');
            historyContent.innerHTML = '';
            historyContent.innerHTML += `<h3 class="text-xl font-bold mb-4">Feeding History</h3>`;
            const sortedFeedings = [...allFeedings].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const groupedByDate = sortedFeedings.reduce((acc, feed) => { const date = dayjs(feed.timestamp).format('YYYY-MM-DD'); if (!acc[date]) acc[date] = []; acc[date].push(feed); return acc; }, {});
            const sortedDates = Object.keys(groupedByDate).sort().reverse();
            const todayStr = dayjs().format('YYYY-MM-DD');
            if (sortedDates.length === 0) { historyContent.innerHTML += '<p class="text-gray-500 dark:text-gray-400">No feeding history found.</p>'; }
            else {
                const feedingHistoryHTML = sortedDates.map(date => {
                    const isToday = (date === todayStr);
                    const dayTotal = groupedByDate[date].reduce((sum, feed) => sum + feed.amount, 0);
                    const headerHTML = `<div class="history-day-header flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg cursor-pointer select-none"><div><h4 class="font-bold">${dayjs(date).format('dddd, MMMM D')}</h4><p class="text-sm text-gray-500 dark:text-gray-400">Total: ${dayTotal} ml (${groupedByDate[date].length} feedings)</p></div><span class="arrow-icon" style="transform: ${isToday ? 'rotate(0deg)' : 'rotate(-90deg)'};">${chevronDownIcon}</span></div>`;
                    const contentHTML = `<div class="history-day-content ml-3 mt-2 pl-3 border-l-2 border-gray-200 dark:border-gray-600" style="${isToday ? 'display: block;' : 'display: none;'}"><div class="space-y-2">${groupedByDate[date].map(createFeedingHTML).join('')}</div></div>`;
                    return `<div class="mb-2">${headerHTML}${contentHTML}</div>`;
                }).join('');
                historyContent.innerHTML += feedingHistoryHTML;
            }
            historyContent.innerHTML += `<h3 class="text-xl font-bold mt-8 mb-4">Weight History</h3>`;
            const sortedWeights = [...allWeights].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (sortedWeights.length > 0) {
                if (sortedWeights.length > 1) { const chartCanvas = document.createElement('canvas'); chartCanvas.style.marginBottom = '20px'; historyContent.appendChild(chartCanvas); renderWeightChart(chartCanvas, sortedWeights); }
                const tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th scope="col" class="px-4 py-3">Date</th><th scope="col" class="px-4 py-3">Time</th><th scope="col" class="px-4 py-3 text-right">Weight</th></tr></thead><tbody>` +
                    sortedWeights.map(w => `<tr class="border-b dark:border-gray-700"><td class="px-4 py-3">${dayjs(w.timestamp).format('MMM D, YYYY')}</td><td class="px-4 py-3">${dayjs(w.timestamp).format('HH:mm')}</td><td class="px-4 py-3 font-medium text-right">${w.grams} g</td></tr>`).join('') + `</tbody></table></div>`;
                historyContent.innerHTML += tableHTML;
            } else { historyContent.innerHTML += '<p class="text-gray-500 dark:text-gray-400">No weight history found.</p>'; }
            document.getElementById('history-modal').style.display = 'flex';
        }
        function renderWeightChart(canvas, weights) {
            if (weightChart) weightChart.destroy();
            const chartData = [...weights].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            weightChart = new Chart(canvas, { type: 'line', data: { labels: chartData.map(w => dayjs(w.timestamp).format('MMM D')), datasets: [{ label: 'Weight (g)', data: chartData.map(w => w.grams), borderColor: '#ec4899', tension: 0.1 }] } });
        }
        function calculateAndDisplayAge() {
            const ageInDaysEl = document.getElementById('age-in-days');
            if (!ageInDaysEl) return;
            const birthDate = dayjs(BABY_BIRTHDAY);
            const now = dayjs();
            let ageText = '';
            if (now.isBefore(birthDate)) {
                 ageText = `Arriving in ${birthDate.fromNow(true)}`;
            } else {
                const format = ageFormats[currentAgeFormatIndex];
                switch (format) {
                    case 'months-days': const m=now.diff(birthDate,'month'); ageText=`${m} month, ${now.diff(birthDate.add(m,'month'),'day')} days`; break;
                    case 'weeks-days': const d=now.diff(birthDate,'day'); ageText=`${Math.floor(d/7)} weeks, ${d%7} days`; break;
                    case 'hours': ageText=`${now.diff(birthDate,'hour').toLocaleString()} hours old`; break;
                    case 'minutes': ageText=`${now.diff(birthDate,'minute').toLocaleString()} minutes old`; break;
                    case 'seconds': ageText=`${now.diff(birthDate,'second').toLocaleString()} seconds old`; break;
                    default: ageText=`${now.diff(birthDate,'day')} days old`; break;
                }
            }
            ageInDaysEl.textContent = ageText;
        }
        function handleAgeClick() {
            currentAgeFormatIndex = (currentAgeFormatIndex + 1) % ageFormats.length;
            calculateAndDisplayAge();
            clearInterval(ageUpdateInterval);
            if (ageFormats[currentAgeFormatIndex] === 'seconds') {
                ageUpdateInterval = setInterval(calculateAndDisplayAge, 1000);
            }
        }
        const applyTheme = (theme) => {
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                if (themeToggleBtn) themeToggleBtn.innerHTML = sunIcon;
            } else {
                document.documentElement.classList.remove('dark');
                if (themeToggleBtn) themeToggleBtn.innerHTML = moonIcon;
            }
        };

        // --- Audio Control Logic ---
        function setupAudioControls() {
            const audio = document.getElementById('myCorrectaudio');
            const audioBtn = document.getElementById('audio-toggle-btn');
            
            if (!audio || !audioBtn) return;

            audioBtn.innerHTML = playIcon; // Start with play icon

            audio.addEventListener('play', () => { audioBtn.innerHTML = pauseIcon; });
            audio.addEventListener('pause', () => { audioBtn.innerHTML = playIcon; });
            
            audioBtn.addEventListener('click', () => {
                if (audio.paused) {
                    audio.play().catch(error => console.log("Autoplay prevented:", error));
                } else {
                    audio.pause();
                }
            });
        }
        
        function setupTheme() {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const toggleTheme = () => {
                const isCurrentlyDark = document.documentElement.classList.contains('dark');
                const newTheme = isCurrentlyDark ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            };
            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('baby-name').textContent = BABY_NAME;
            setupTheme();
            calculateAndDisplayAge();
            loadData();
            setupAudioControls();

            // Event Listeners
            const amountSlider = document.getElementById('amount');
            const amountValue = document.getElementById('amount-value');
            if(amountSlider && amountValue) {
                amountValue.textContent = `${amountSlider.value} ml`;
                amountSlider.addEventListener('input', (e) => {
                    amountValue.textContent = `${e.target.value} ml`;
                });
            }

            document.getElementById('feeding-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveData({
                    type: 'add_feeding',
                    amount: parseInt(document.getElementById('amount').value),
                    notes: document.getElementById('notes').value,
                    timestamp: new Date().toISOString()
                });
                e.target.reset();
                amountValue.textContent = `100 ml`;
            });
            document.getElementById('age-in-days').addEventListener('click', handleAgeClick);
            document.getElementById('view-history-btn').addEventListener('click', showHistory);
            document.getElementById('close-history-btn').addEventListener('click', () => document.getElementById('history-modal').style.display = 'none');
            document.getElementById('close-insight-btn').addEventListener('click', () => document.getElementById('insight-detail-modal').style.display = 'none');
            document.getElementById('close-weight-btn').addEventListener('click', () => document.getElementById('weight-modal').style.display = 'none');
            document.getElementById('cancel-edit-btn').addEventListener('click', () => document.getElementById('edit-modal').style.display = 'none');
            document.getElementById('latest-weight-card').addEventListener('click', () => document.getElementById('weight-modal').style.display = 'flex');

            document.getElementById('insight-section').addEventListener('click', (e) => {
                const text = e.currentTarget.dataset.expandedText;
                if(text) {
                    document.getElementById('insight-detail-content').textContent = text;
                    document.getElementById('insight-detail-modal').style.display = 'flex';
                }
            });

            document.getElementById('weight-form').addEventListener('submit', e => {
                e.preventDefault();
                const grams = document.getElementById('weight-grams').value;
                if (grams) {
                    saveData({
                        type: 'add_weight',
                        grams: parseInt(grams),
                        timestamp: new Date().toISOString()
                    });
                    document.getElementById('weight-modal').style.display = 'none';
                    e.target.reset();
                }
            });
            
            document.getElementById('edit-form').addEventListener('submit', e => {
                e.preventDefault();
                saveData({
                    type: 'edit_feeding',
                    id: document.getElementById('edit-id').value,
                    amount: parseInt(document.getElementById('edit-amount').value),
                    notes: document.getElementById('edit-notes').value,
                });
                document.getElementById('edit-modal').style.display = 'none';
            });
            
            document.getElementById('delete-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this entry?')) {
                     saveData({
                         type: 'delete_feeding',
                         id: document.getElementById('edit-id').value,
                    });
                     document.getElementById('edit-modal').style.display = 'none';
                }
            });
            
            document.body.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const historyHeader = e.target.closest('.history-day-header');
                
                if (editBtn) {
                    document.getElementById('edit-id').value = editBtn.dataset.id;
                    document.getElementById('edit-amount').value = editBtn.dataset.amount;
                    document.getElementById('edit-notes').value = editBtn.dataset.notes;
                    document.getElementById('edit-modal').style.display = 'flex';
                }
                
                if (historyHeader) {
                    const content = historyHeader.nextElementSibling;
                    const arrow = historyHeader.querySelector('.arrow-icon');
                    const isVisible = content.style.display === 'block';
                    content.style.display = isVisible ? 'none' : 'block';
                    arrow.style.transform = isVisible ? 'rotate(-90deg)' : 'rotate(0deg)';
                }
            });
        });
    </script>
</body>
</html>
